export default class Game extends Laya.Script{constructor(){super(),this.foodMap=new Map,this.preFood=null,this.prePlayer=null,this.prePlayerSelf=null,this.preChilun=null,this.chiluns=[],this.selfPlayer=null,this.selfPlayerNode=null,this.playerMap=new Map,this.refreshMsgArray=[],this.mod=0,this.controller=null,this.sendEnterGameMsg=!1}recalPlayerNode(player){let pNode=this.owner.getChildByName("player"+player.playerID);if(null==pNode)return;pNode.x=player.centerX-player.r,pNode.y=player.centerY-player.r,pNode.width=2*player.r,pNode.height=pNode.width,pNode.name="player"+player.playerID;let nameTxtNode=pNode.getChildByName("PlayerName");nameTxtNode.width=pNode.width,nameTxtNode.height=pNode.height}onEnable(){game=this}onDisable(){console.log("disable")}onUpdate(){if(!this.sendEnterGameMsg&&socketConnected){console.log("send"),this.sendEnterGameMsg=!0;let enterGameMsg=pbgo.EnterGame.create();enterGameMsg.playerID=-1,sendMsg(CMD_ENTER_GAME,enterGameMsg)}this.frameRefresh();for(let index=0;index<this.chiluns.length;index++){this.chiluns[index].rotation++}}frameRefresh(){let num=this.refreshMsgArray.length;if(num>0){num>1&&(num=1);for(let index=0;index<num;index++){let msg=this.refreshMsgArray.shift();for(const idx in msg.players){let player=msg.players[idx];if(player.playerID==this.selfPlayer.playerID){if(this.selfPlayer.isDead){console.log("玩家自己死亡后复活。。。。重新创建"),this.selfPlayer.centerX=player.centerX,this.selfPlayer.centerY=player.centerY,this.selfPlayer.r=player.r,this.selfPlayer.speed=player.speed,this.selfPlayer.mod=player.mod,this.selfPlayer.isDead=!1,this.playerMap.set(this.selfPlayer.playerID,this.selfPlayer),this.createPlayerNode(this.selfPlayer);continue}if(this.selfPlayer.speed=player.speed,this.selfPlayer.r<player.r&&(this.selfPlayer.r=player.r,this.recalPlayerNode(this.selfPlayer)),msg.selfMod<this.mod)continue;this.selfPlayer.centerX==player.centerX&&this.selfPlayer.centerY==player.centerY||(this.selfPlayer.r=player.r,this.selfPlayer.centerX=player.centerX,this.selfPlayer.centerY=player.centerY,this.recalPlayerNode(this.selfPlayer));continue}let p=this.playerMap.get(player.playerID);null==p&&((p=new Player).centerX=player.centerX,p.centerY=player.centerY,p.r=player.r,p.speed=player.speed,p.playerID=player.playerID,p.playerName=player.playerName,this.playerMap.set(player.playerID,p),this.createPlayerNode(p));for(let i=0;i<player.moveFrames.length;i++)p.moveFrames.push(player.moveFrames[i])}for(const idx in msg.foods){let food=msg.foods[idx],foodNode=this.owner.getChildByName("food"+food.id);null==foodNode&&(foodNode=this.createFoodNode(food)),foodNode.x=food.centerX-food.r,foodNode.y=food.centerY-food.r,this.foodMap.set(food.id,food)}if(index==num-1){for(let value of this.playerMap.values()){let found=!1;for(const idx in msg.players){if(msg.players[idx].playerID==value.playerID){found=!0;break}}found||(console.log("delete player "+value.playerID),this.playerMap.delete(value.playerID),this.owner.getChildByName("player"+value.playerID).destroy(),value.playerID==this.selfPlayer.playerID&&(this.selfPlayer.isDead=!0))}for(let value of this.foodMap.values()){let found=!1;for(const idx in msg.foods){if(msg.foods[idx].id==value.id){found=!0;break}}found||(this.foodMap.delete(value.id),this.owner.getChildByName("food"+value.id).destroy())}}}}}createPlayerNode(player){let pNode=null;(pNode=player.playerID==this.selfPlayer.playerID?this.prePlayerSelf.create():this.prePlayer.create()).x=player.centerX-player.r,pNode.y=player.centerY-player.r,pNode.width=2*player.r,pNode.height=pNode.width,pNode.name="player"+player.playerID;let nameTxtNode=pNode.getChildByName("PlayerName");return nameTxtNode.text=player.playerName,nameTxtNode.x=pNode.x,nameTxtNode.y=pNode.y,nameTxtNode.width=pNode.width,nameTxtNode.height=pNode.height,this.owner.addChild(pNode),console.log("创建玩家 ::"+player.playerName),pNode}createFoodNode(food){let fNode=this.preFood.create();return fNode.x=food.centerX-food.r,fNode.y=food.centerY-food.r,fNode.width=2*food.r,fNode.height=fNode.width,fNode.name="food"+food.id,this.owner.addChild(fNode),fNode}enterGame(enterGameAck){console.log("enter game");let player=new Player;player.centerX=enterGameAck.self.centerX,player.centerY=enterGameAck.self.centerY,player.r=enterGameAck.self.r,player.speed=enterGameAck.self.speed,player.playerID=enterGameAck.self.playerID,player.playerName=enterGameAck.self.playerName,this.playerMap.set(player.playerID,player),this.selfPlayer=player,this.selfPlayerNode=this.createPlayerNode(player);for(let index=0;index<enterGameAck.players.length;index++){let element=enterGameAck.players[index],player=new Player;player.centerX=element.centerX,player.centerY=element.centerY,player.r=element.r,player.playerID=element.playerID,player.playerName=element.playerName,this.playerMap.set(player.playerID,player),this.createPlayerNode(player)}for(let index=0;index<enterGameAck.players.length;index++){let element=enterGameAck.foods[index],food=new Food;food.centerX=element.centerX,food.centerY=element.centerY,food.r=element.r,food.id=element.id,this.foodMap.set(food.id,food),this.createFoodNode(food)}for(let index=0;index<enterGameAck.chiluns.length;index++){let element=enterGameAck.chiluns[index],chilun=this.preChilun.create();chilun.x=element.centerX,chilun.y=element.centerY,chilun.width=2*element.r,chilun.height=2*element.r,this.owner.addChild(chilun),this.chiluns.push(chilun),console.log(chilun.x+","+chilun.y),console.log("齿轮：（"+element.centerX+","+element.centerX+")")}this.controller=new Control}refresh(refreshMsg){this.refreshMsgArray.push(refreshMsg)}}